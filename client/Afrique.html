<!DOCTYPE html>

<script src="leaflet.js"> // Bibliothèque Leaflet : http://leafletjs.com/ </script>

<title>Exemple de carte glissante</title>
<link rel="stylesheet" type="text/css" href="leaflet.css" />
<link rel="stylesheet" type="text/css" href="style.css"/>
<script src="leaflet.markercluster-src.js"></script>
<link rel="stylesheet" href="MarkerCluster.css" />


<meta charset="utf-8">

<!-- Récupération de la liste des pays d'Afrique au chargement de la page -->
<body onload="load_data();">

  <h1>Divers pays d'Afrique</h1>
  <div>

  <!-- Zone pour l'insertion de la carte OSM via Leaflet -->
  <div class="row">
  <div class="column"><div id="map" style="margin-bottom:1.33em"></div></div>

  <!-- Zone pour l'affichage dynamique des descriptions -->
  <div class="column"><p id="description"></p></div>
  </div>

  </div>
 </body>


<script>

// Création d'une carte dans la balise div "map",
// et position de la vue sur un point donné et un niveau de zoom
var map = L.map('map').setView([2.25,18.51], 3);

// Ajout d'une couche de dalles OpenStreetMap
L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
     }).addTo(map);

// Création d'un environnement Cluster pour rassembler les marqueurs proches
var markerClusters = L.markerClusterGroup({
    iconCreateFunction: function(cluster) {
        return L.divIcon({
            html: cluster.getChildCount(),
            // Cluster personnalisé cf MakerCluster.css
            className: 'mycluster',
            iconSize: null
        });
    }
});

// Fonction appelée au chargement de la page
function load_data () {

  // objet pour l'envoi d'une requête Ajax
  var xhr = new XMLHttpRequest();

  // fonction appelée lorsque la réponse à la requête (liste des lieux insolites) sera arrivée
  xhr.onload = function() {

    // transformation des données renvoyées par le serveur
    // responseText est du type string, data est une liste
    var data = JSON.parse(this.responseText);

    // boucle sur les lieux
    for ( n = 0; n < data.length; n++ ) {
      // insertion d'un marqueur à la position du lieu,
      // attachement d'une popup, capture de l'événement 'clic'
      // ajout d'une propriété personnalisée au marqueur
 
       var m = L.marker([data[n].lat,data[n].lon])
      .bindPopup('Lieu = '+data[n].name)
      .addEventListener('click',OnMarkerClick)
      
      // Création d'un identifiant unique pour localiser le marqueur
      m.idnum = data[n].id
      
      // Ajout du marqueur dans le Cluster
      markerClusters.addLayer( m );
    }
    map.addLayer( markerClusters );
  };



  // Envoi de la requête Ajax pour la récupération de la liste des lieux insolites
  xhr.open('GET','/location',true);
  xhr.send();
}

// Fonction appelée lors d'un clic sur un marqueur
function OnMarkerClick (e) {

  // objet pour l'envoi d'une requête Ajax
  var xhr = new XMLHttpRequest();

  // fonction appelée lorsque la réponse à la requête (description d'un lieu insolite) sera arrivée
  xhr.onload = function() {

    // transformation des données renvoyées par le serveur
    // responseText est du type string, data est un objet
    var data = JSON.parse(this.responseText);
    map.setView([data.lat,data.lon], 6);

    // affichage dans la zone 'description' du nom (reprise dans le popup)
    // et des informations récupérées par l'appel au serveur
    description.innerHTML =  '<b><i>' + e.target.getPopup().getContent() + '</i></b><br>'+
                             '<div><span class="label">Continent : </span>' + 'Afrique' + '</div>' +
                             '<div><span class="label">Capital : </span>' + data.cap + '</div>' +
                             '<div><span class="label">Latitude : </span>' + data.lat.toFixed(2) + '</div>' +
                             '<div><span class="label">Longitude : </span>' + data.lon.toFixed(2) + '</div>' +
                             '<div><span class="label">Read more on : </span><a href="https://en.wikipedia.org/wiki/' + data.name + '">wikipedia</a></div>' +
                             '<img src="' + data.img + '"/>';
  };

  // Le numéro du lieu est récupéré via la propriété personnalisée du marqueur
  var idnum = e.target.idnum

  // Envoi de la requête Ajax pour la récupération des informations relatives du pays de numéro idnum
  xhr.open('GET','/description/'+idnum,true);
  xhr.send();
}
</script>
